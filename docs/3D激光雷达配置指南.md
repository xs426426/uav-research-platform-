# 3D激光雷达配置指南

> 为无人机添加3D激光雷达（Velodyne VLP-16）

---

## 步骤1：检查现有激光雷达模型

在Ubuntu虚拟机中执行：

```bash
# 查看PX4自带的激光雷达模型
ls ~/PX4-Autopilot/Tools/sitl_gazebo/models/ | grep -i lidar

# 常见的有：
# iris_foggy_lidar - 带雾天3D激光雷达
# iris_rplidar - 2D激光雷达
```

---

## 步骤2：安装Velodyne激光雷达插件

```bash
# 安装Velodyne Gazebo插件
sudo apt-get update
sudo apt-get install -y ros-noetic-velodyne-gazebo-plugins ros-noetic-velodyne-description

# 安装点云处理工具
sudo apt-get install -y ros-noetic-pcl-ros ros-noetic-pcl-conversions
```

---

## 步骤3：创建带3D激光雷达的无人机模型

```bash
# 复制现有模型作为基础
cd ~/PX4-Autopilot/Tools/sitl_gazebo/models/
cp -r iris_depth_camera iris_3d_lidar
```

编辑 `iris_3d_lidar/iris_3d_lidar.sdf`，在 `</model>` 前添加：

```xml
<!-- Velodyne VLP-16 3D激光雷达 -->
<include>
  <uri>model://velodyne_VLP16</uri>
  <pose>0 0 0.1 0 0 0</pose>
  <name>velodyne</name>
</include>
<joint name="velodyne_joint" type="fixed">
  <parent>base_link</parent>
  <child>velodyne::velodyne_base_link</child>
</joint>
```

---

## 步骤4：使用PX4自带的foggy_lidar（推荐）

PX4已经有一个带3D激光雷达的模型：

```bash
# 启动带3D激光雷达的仿真
cd ~/PX4-Autopilot
source ~/catkin_ws/devel/setup.bash
source Tools/setup_gazebo.bash $(pwd) $(pwd)/build/px4_sitl_default
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$(pwd):$(pwd)/Tools/sitl_gazebo

roslaunch px4 mavros_posix_sitl.launch vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_foggy_lidar/iris_foggy_lidar.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/small_warehouse.world
```

---

## 步骤5：验证3D激光雷达话题

```bash
# 查看激光雷达话题
rostopic list | grep -E "lidar|velodyne|points"

# 常见话题：
# /velodyne_points - Velodyne点云
# /lidar/points - 通用激光雷达点云
# /scan - 2D扫描数据

# 查看点云数据
rostopic echo /velodyne_points --noarr | head -20

# 查看点云频率
rostopic hz /velodyne_points
```

---

## 步骤6：在RViz中可视化3D点云

```bash
# 启动RViz
rviz
```

在RViz中：
1. 设置Fixed Frame为 `map` 或 `base_link`
2. 点击 Add → By topic → 选择点云话题 → PointCloud2
3. 调整点大小为 0.05
4. 选择颜色方案：FlatColor 或 Intensity

---

## 快速测试命令

### 使用foggy_lidar模型（最简单）

```bash
cd ~/PX4-Autopilot
source ~/catkin_ws/devel/setup.bash
source Tools/setup_gazebo.bash $(pwd) $(pwd)/build/px4_sitl_default
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$(pwd):$(pwd)/Tools/sitl_gazebo

# 在仓库场景测试
roslaunch px4 mavros_posix_sitl.launch vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_foggy_lidar/iris_foggy_lidar.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/small_warehouse.world
```

---

## 3D激光雷达参数说明

| 参数 | VLP-16 | 说明 |
|------|--------|------|
| 线数 | 16 | 垂直方向16条激光线 |
| 水平FOV | 360° | 全向扫描 |
| 垂直FOV | ±15° | 上下各15度 |
| 最大距离 | 100m | 检测范围 |
| 点云频率 | 10-20Hz | 每秒扫描次数 |
| 点数/帧 | ~30000 | 每帧点云数量 |

---

## 传感器组合方案

### 方案A：深度相机 + 3D激光雷达（推荐）

```bash
# 需要自定义模型，同时包含两种传感器
# 深度相机：近距离精细感知
# 3D激光雷达：远距离全向感知
```

### 方案B：仅3D激光雷达

```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_foggy_lidar/iris_foggy_lidar.sdf
```

### 方案C：深度相机（当前配置）

```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf
```

---

## 下一步

配置好3D激光雷达后，可以进行：
1. **FAST-LIO2** - 激光雷达里程计，实现精确定位
2. **点云SLAM** - 使用激光雷达进行建图
3. **3D避障** - 基于点云的全向避障
