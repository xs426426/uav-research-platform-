# 无人机仿真测试场景指南

> PX4 + Gazebo 场景库及使用方法

---

## 快速启动命令模板

```bash
# 通用启动命令格式
cd ~/PX4-Autopilot
source ~/catkin_ws/devel/setup.bash
source Tools/setup_gazebo.bash $(pwd) $(pwd)/build/px4_sitl_default
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$(pwd):$(pwd)/Tools/sitl_gazebo

roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/【场景名】.world
```

---

## AWS 专业室内场景（推荐）

### 1. AWS 小型仓库 ⭐ 最稳定
**文件**: `small_warehouse.world`
**特点**: 完整仓库环境，有货架、托盘车、地面标记、墙壁

```bash
roslaunch px4 mavros_posix_sitl.launch vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/small_warehouse.world
```

### 2. AWS 医院 ⭐ 室内探索推荐
**文件**: `hospital.world`
**特点**: 单层医院，有走廊、病房、办公区、医疗设备

```bash
roslaunch px4 mavros_posix_sitl.launch vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/hospital.world
```

**其他医院场景**:
- `hospital_two_floors.world` - 两层医院
- `hospital_three_floors.world` - 三层医院

### 3. AWS 书店
**文件**: `bookstore.world`
**特点**: 室内商店环境，有书架、桌椅、收银台

```bash
roslaunch px4 mavros_posix_sitl.launch vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/bookstore.world
```

### 4. AWS 无屋顶仓库
**文件**: `no_roof_small_warehouse.world`
**特点**: 无屋顶版仓库，更适合无人机高空飞行

```bash
roslaunch px4 mavros_posix_sitl.launch vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/no_roof_small_warehouse.world
```

---

## AWS 场景安装方法

如果缺少上述场景，执行以下命令安装：

```bash
# 下载 AWS 场景包
cd ~
git clone https://github.com/aws-robotics/aws-robomaker-small-warehouse-world.git
git clone https://github.com/aws-robotics/aws-robomaker-hospital-world.git
git clone https://github.com/aws-robotics/aws-robomaker-bookstore-world.git

# 复制到 PX4 目录
cp -r ~/aws-robomaker-small-warehouse-world/worlds/* ~/PX4-Autopilot/Tools/sitl_gazebo/worlds/
cp -r ~/aws-robomaker-small-warehouse-world/models/* ~/PX4-Autopilot/Tools/sitl_gazebo/models/

cp -r ~/aws-robomaker-hospital-world/worlds/* ~/PX4-Autopilot/Tools/sitl_gazebo/worlds/
cp -r ~/aws-robomaker-hospital-world/models/* ~/PX4-Autopilot/Tools/sitl_gazebo/models/

cp -r ~/aws-robomaker-bookstore-world/worlds/* ~/PX4-Autopilot/Tools/sitl_gazebo/worlds/
cp -r ~/aws-robomaker-bookstore-world/models/* ~/PX4-Autopilot/Tools/sitl_gazebo/models/
```

---

## 场景对比表

| 场景 | 类型 | 复杂度 | 适用测试 |
|------|------|--------|----------|
| small_warehouse | 仓库 | 中 | 避障、货物识别 |
| hospital | 医院 | 高 | 室内探索、搜救 |
| bookstore | 书店 | 中 | 室内导航、SLAM |
| no_roof_small_warehouse | 仓库(无顶) | 中 | 高空侦察 |

---

## 推荐测试场景

### 1. 仓库场景 (warehouse) ⭐推荐
**特点**: 室内环境，有货架、墙壁，适合避障测试

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/warehouse.world
```

---

### 2. 空旷场地 (empty)
**特点**: 最简单场景，只有地面，适合基础测试

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/empty.world
```

---

### 3. 湾区地形 (baylands) ⭐推荐
**特点**: 户外环境，有树木、建筑，适合户外导航测试

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/baylands.world
```

---

### 4. 麦克米兰机场 (mcmillan_airfield)
**特点**: 大型户外机场环境

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/mcmillan_airfield.world
```

---

### 5. 索诺玛赛道 (sonoma_raceway)
**特点**: 赛道环境，有围栏和建筑

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/sonoma_raceway.world
```

---

### 6. KSQL 机场 (ksql_airport)
**特点**: 小型机场环境

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/ksql_airport.world
```

---

### 7. 船舶甲板 (boat)
**特点**: 海上船只甲板，适合海上起降测试

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/boat.world
```

---

### 8. 带风的场景 (windy)
**特点**: 空旷场地但有风力干扰

```bash
roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/windy.world
```

---

## 不同传感器配置

### 基础无人机（无额外传感器）
```bash
roslaunch px4 mavros_posix_sitl.launch vehicle:=iris
```

### 带深度相机
```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf
```

### 带2D激光雷达
```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_rplidar/iris_rplidar.sdf
```

### 带双目相机
```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_stereo_camera/iris_stereo_camera.sdf
```

### 带光流传感器
```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_opt_flow/iris_opt_flow.sdf
```

### 带3D激光雷达（雾天）
```bash
sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_foggy_lidar/iris_foggy_lidar.sdf
```

---

## 一键启动脚本

### 创建场景选择脚本

```bash
cat > ~/start_with_scene.sh << 'SCRIPT'
#!/bin/bash

echo "========== 选择测试场景 =========="
echo "1. warehouse   - 仓库（室内避障）"
echo "2. baylands    - 湾区（户外导航）"
echo "3. empty       - 空地（基础测试）"
echo "4. sonoma      - 赛道（围栏环境）"
echo "5. mcmillan    - 机场（大型户外）"
echo "6. boat        - 船舶（海上测试）"
echo "=================================="
read -p "选择 (1-6): " choice

case $choice in
    1) WORLD="warehouse" ;;
    2) WORLD="baylands" ;;
    3) WORLD="empty" ;;
    4) WORLD="sonoma_raceway" ;;
    5) WORLD="mcmillan_airfield" ;;
    6) WORLD="boat" ;;
    *) WORLD="empty" ;;
esac

echo ""
echo "启动场景: $WORLD"
echo ""

cd ~/PX4-Autopilot
source ~/catkin_ws/devel/setup.bash
source Tools/setup_gazebo.bash $(pwd) $(pwd)/build/px4_sitl_default
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$(pwd):$(pwd)/Tools/sitl_gazebo

roslaunch px4 mavros_posix_sitl.launch \
    vehicle:=iris \
    sdf:=$(pwd)/Tools/sitl_gazebo/models/iris_depth_camera/iris_depth_camera.sdf \
    world:=$(pwd)/Tools/sitl_gazebo/worlds/${WORLD}.world
SCRIPT

chmod +x ~/start_with_scene.sh
```

### 使用方法
```bash
~/start_with_scene.sh
```

---

## 场景特点对比

| 场景 | 类型 | 障碍物 | 适合测试 |
|------|------|--------|----------|
| warehouse | 室内 | 货架、墙壁 | 避障、室内导航 |
| baylands | 户外 | 树木、建筑 | 户外导航、GPS定位 |
| empty | 空地 | 无 | 基础飞行、调试 |
| sonoma_raceway | 户外 | 围栏、看台 | 轨迹跟踪 |
| mcmillan_airfield | 机场 | 跑道、建筑 | 大范围导航 |
| boat | 海上 | 船只结构 | 精准降落 |
| windy | 空地 | 无（有风） | 抗扰控制 |

---

## 启动后的操作

1. 等待 `pxh>` 出现
2. 执行：`param set COM_RCL_EXCEPT 4`
3. 新终端启动控制：
   ```bash
   cd ~/uav-research-platform-/src/phase1_planning
   python3 goal_sender.py
   ```
4. 按 `t` 起飞测试

---

## 注意事项

1. **首次加载场景可能很慢**（需要下载模型）
2. **虚拟机性能有限**，复杂场景可能卡顿
3. **warehouse 场景**是最适合避障测试的
4. 如果场景加载失败，先试 `empty.world` 确认基础功能正常
