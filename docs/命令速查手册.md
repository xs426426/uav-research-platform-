# 无人机仿真平台 - 命令速查手册

> 所有常用命令的分类整理，复制粘贴即可使用

---

## 一、代码同步（Git）

### Windows → GitHub → Ubuntu 流程

```bash
# === Windows 端（VSCode 终端）===
# 推送代码到 GitHub（Claude 自动执行）

# === Ubuntu 虚拟机 ===
# 拉取最新代码
cd ~/uav-research-platform-
git pull
```

### Git 常用命令

```bash
# 查看状态
git status

# 查看远程仓库
git remote -v

# 强制覆盖本地（谨慎使用）
git fetch --all
git reset --hard origin/main
```

---

## 二、ROS 编译

### 编译工作空间

```bash
# 进入工作空间
cd ~/catkin_ws

# 编译
catkin_make

# 加载环境变量（每次新开终端都要执行，或写入 ~/.bashrc）
source devel/setup.bash
```

### 一次性写入环境变量

```bash
# 把这行加入 ~/.bashrc，以后就不用每次 source 了
echo "source ~/catkin_ws/devel/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

---

## 三、仿真启动（三终端）

### 终端 1：PX4 + Gazebo

```bash
cd ~/PX4-Autopilot
make px4_sitl gazebo
```

等待出现 `pxh>` 后，设置参数：

```bash
# 允许无遥控器使用 OFFBOARD 模式
param set COM_RCL_EXCEPT 4
```

### 终端 2：MAVROS

```bash
roslaunch mavros px4.launch fcu_url:="udp://:14540@127.0.0.1:14557"
```

### 终端 3：运行你的代码

```bash
# Phase 0 - 基础控制测试
cd ~/uav-research-platform-/src/phase0_foundation
python3 offboard_control.py

# Phase 1 - 路径规划节点（ROS 方式）
rosrun phase1_planning path_planner_node.py

# 或直接运行 Python 文件
cd ~/uav-research-platform-/src/phase1_planning
python3 path_planner_node.py
```

---

## 四、ROS 调试命令

### 话题相关

```bash
# 查看所有话题
rostopic list

# 查看话题内容（实时输出，Ctrl+C 退出）
rostopic echo /mavros/state
rostopic echo /mavros/local_position/pose

# 查看话题发布频率
rostopic hz /mavros/local_position/pose

# 查看话题类型
rostopic type /mavros/state
```

### 节点相关

```bash
# 查看所有节点
rosnode list

# 查看节点信息
rosnode info /mavros

# 杀死节点
rosnode kill /mavros
```

### 可视化工具

```bash
# 节点关系图
rqt_graph

# 话题监控
rqt_topic

# 3D 可视化
rviz
```

---

## 五、PX4 命令（pxh> 提示符下）

### 飞行控制

```bash
# 查看状态
commander status

# 手动解锁
commander arm

# 手动上锁
commander disarm

# 起飞
commander takeoff

# 降落
commander land

# 切换模式
commander mode offboard
commander mode manual
```

### 参数设置

```bash
# 查看参数
param show COM_RCL_EXCEPT

# 设置参数
param set COM_RCL_EXCEPT 4    # 允许无遥控器 OFFBOARD
param set NAV_RCL_ACT 0       # 遥控器丢失不触发 failsafe
param set NAV_DLL_ACT 0       # 数据链路丢失不触发 failsafe
param set COM_ARM_WO_GPS 1    # 允许无 GPS 解锁

# 保存参数
param save
```

---

## 六、进程管理

### 查看进程

```bash
# 查看 PX4 相关进程
ps aux | grep px4

# 查看 ROS 相关进程
ps aux | grep ros

# 查看 Gazebo 相关进程
ps aux | grep gz
```

### 杀死进程

```bash
# 杀死指定 PID
kill -9 <PID>

# 杀死所有 PX4 进程
killall px4

# 杀死 Gazebo
killall gzserver gzclient

# 一键清理所有仿真进程
killall px4 gzserver gzclient rosmaster roscore
```

---

## 七、环境检查

### 检查 ROS 环境

```bash
# 查看 ROS 版本
rosversion -d

# 查看 ROS 环境变量
printenv | grep ROS

# 查看 ROS 包路径
echo $ROS_PACKAGE_PATH
```

### 检查连接状态

```bash
# 检查 MAVROS 是否连接到 PX4
rostopic echo /mavros/state
# 看 connected: True 表示成功

# 检查无人机位置
rostopic echo /mavros/local_position/pose
```

---

## 八、快速启动脚本

### 创建一键启动脚本

```bash
# 创建脚本
cat > ~/start_sim.sh << 'EOF'
#!/bin/bash
echo "=== 启动 PX4 + Gazebo ==="
gnome-terminal -- bash -c "cd ~/PX4-Autopilot && make px4_sitl gazebo; exec bash" &

sleep 15

echo "=== 启动 MAVROS ==="
gnome-terminal -- bash -c "source ~/.bashrc && roslaunch mavros px4.launch fcu_url:='udp://:14540@127.0.0.1:14557'; exec bash" &

echo "=== 仿真环境启动中... ==="
echo "请在 PX4 终端执行: param set COM_RCL_EXCEPT 4"
EOF

# 添加执行权限
chmod +x ~/start_sim.sh
```

### 使用脚本

```bash
~/start_sim.sh
```

---

## 九、常见问题快速解决

### 问题：Gazebo 启动卡住

```bash
# 清理并重启
killall gzserver gzclient
cd ~/PX4-Autopilot
make px4_sitl gazebo
```

### 问题：MAVROS 连接失败

```bash
# 检查 PX4 是否启动
# 确保看到 pxh> 提示符后再启动 MAVROS

# 重启 MAVROS
# Ctrl+C 停止后重新运行
roslaunch mavros px4.launch fcu_url:="udp://:14540@127.0.0.1:14557"
```

### 问题：无人机不起飞

```bash
# 在 PX4 终端设置参数
param set COM_RCL_EXCEPT 4

# 检查连接状态
rostopic echo /mavros/state
# 确保 connected: True
```

### 问题：找不到 ROS 包

```bash
# 重新编译
cd ~/catkin_ws
catkin_make
source devel/setup.bash
```

---

## 十、目录结构速查

```
~/
├── PX4-Autopilot/           # PX4 飞控源码
├── catkin_ws/               # ROS 工作空间
│   ├── src/                 # 源码目录
│   ├── build/               # 编译目录
│   └── devel/               # 开发目录
│       └── setup.bash       # 环境变量脚本
│
└── uav-research-platform-/  # 项目代码（也可以在 catkin_ws/src/ 下）
    ├── src/
    │   ├── phase0_foundation/
    │   │   └── offboard_control.py
    │   └── phase1_planning/
    │       ├── astar_3d.py
    │       ├── rrt_star_3d.py
    │       └── path_planner_node.py
    └── notes/               # 学习笔记
```

---

## 快速参考卡片

```
┌─────────────────────────────────────────────────────────────────┐
│                    仿真启动速查                                  │
├─────────────────────────────────────────────────────────────────┤
│  终端1: cd ~/PX4-Autopilot && make px4_sitl gazebo              │
│         → pxh> param set COM_RCL_EXCEPT 4                       │
├─────────────────────────────────────────────────────────────────┤
│  终端2: roslaunch mavros px4.launch \                           │
│         fcu_url:="udp://:14540@127.0.0.1:14557"                 │
├─────────────────────────────────────────────────────────────────┤
│  终端3: python3 your_script.py                                  │
├─────────────────────────────────────────────────────────────────┤
│  调试:  rostopic echo /mavros/state                             │
│         rostopic list                                           │
├─────────────────────────────────────────────────────────────────┤
│  清理:  killall px4 gzserver gzclient                           │
└─────────────────────────────────────────────────────────────────┘
```
