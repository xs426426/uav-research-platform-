# 01. 系统架构总览

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    你的 Python 代码                          │
│                 (offboard_control.py)                        │
│                                                              │
│  功能：发送位置指令、读取状态、实现飞行逻辑                    │
└─────────────────────┬───────────────────────────────────────┘
                      │ ROS Topics (发布/订阅)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                      MAVROS                                  │
│            (ROS 消息 ↔ MAVLink 协议 转换)                    │
│                                                              │
│  功能：把 ROS 消息翻译成 PX4 能懂的 MAVLink 协议              │
└─────────────────────┬───────────────────────────────────────┘
                      │ MAVLink (UDP 通信)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    PX4 SITL                                  │
│                 (飞控固件仿真版)                              │
│                                                              │
│  功能：飞行控制算法、状态估计、安全保护                       │
└─────────────────────┬───────────────────────────────────────┘
                      │ 传感器/电机数据
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                     Gazebo                                   │
│              (3D 物理仿真，模拟真实世界)                      │
│                                                              │
│  功能：物理引擎、传感器模拟、3D 可视化                        │
└─────────────────────────────────────────────────────────────┘
```

## 二、各组件详解

### 1. ROS (Robot Operating System)

**是什么**：机器人操作系统，实际上是一个通信框架

**核心功能**：
- 节点间通信（话题、服务、动作）
- 硬件抽象
- 包管理

**在本项目中的作用**：
- 提供你的代码和 MAVROS 之间的通信机制
- 管理各个节点的生命周期

### 2. MAVROS

**是什么**：MAVLink 到 ROS 的桥梁

**核心功能**：
- 将 ROS 话题消息转换为 MAVLink 协议
- 将 MAVLink 消息转换为 ROS 话题

**形象比喻**：
```
你的代码说中文 (ROS 消息)
      ↓
   MAVROS (翻译官)
      ↓
PX4 说英文 (MAVLink)
```

### 3. PX4

**是什么**：开源飞控固件

**核心功能**：
- 姿态控制、位置控制
- 状态估计（融合传感器数据）
- 飞行模式管理
- 安全保护（故障检测、failsafe）

**SITL 版本**：Software In The Loop
- 不需要真实硬件
- 在电脑上模拟飞控行为
- 和真实飞控代码完全一致

### 4. Gazebo

**是什么**：3D 物理仿真器

**核心功能**：
- 物理引擎（重力、碰撞、空气动力学）
- 传感器模拟（IMU、GPS、相机、激光雷达）
- 3D 可视化

## 三、数据流向

```
控制指令流向（你 → 无人机）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

你的代码                     MAVROS                      PX4
   │                          │                          │
   │  发布 PoseStamped        │                          │
   │  到 /mavros/setpoint_    │                          │
   │  position/local          │                          │
   ├─────────────────────────→│                          │
   │                          │  转换为 MAVLink          │
   │                          │  SET_POSITION_TARGET     │
   │                          ├─────────────────────────→│
   │                          │                          │  执行控制
   │                          │                          │  算法
   │                          │                          ├───→ Gazebo
   │                          │                          │      (电机)


状态反馈流向（无人机 → 你）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Gazebo                       PX4                       MAVROS                    你的代码
   │                          │                          │                          │
   │  传感器数据              │                          │                          │
   │  (IMU, GPS等)            │                          │                          │
   ├─────────────────────────→│                          │                          │
   │                          │  状态估计                │                          │
   │                          │  计算位置/姿态           │                          │
   │                          │                          │                          │
   │                          │  MAVLink 消息            │                          │
   │                          │  LOCAL_POSITION_NED      │                          │
   │                          ├─────────────────────────→│                          │
   │                          │                          │  转换为 ROS 消息         │
   │                          │                          │  PoseStamped             │
   │                          │                          ├─────────────────────────→│
   │                          │                          │                          │  读取位置
```

## 四、关键概念

### MAVLink 协议

```
MAVLink = Micro Air Vehicle Link

- 轻量级消息协议
- 专为无人机设计
- 支持多种编程语言
- 被 PX4、ArduPilot 等主流飞控使用
```

### SITL vs HITL

```
SITL (Software In The Loop)
├── 纯软件仿真
├── 不需要硬件
├── 开发调试方便
└── 我们目前使用的方式

HITL (Hardware In The Loop)
├── 硬件在环仿真
├── 需要真实飞控板
├── 更接近真实情况
└── 后期可以尝试
```

## 五、总结

```
记住这个简化模型：

    你的代码  ←→  MAVROS  ←→  PX4  ←→  Gazebo
    (决策层)     (翻译层)    (控制层)   (物理层)
```
