# 04. 仿真环境启动流程

## 一、三终端启动概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          完整启动流程                                    │
└─────────────────────────────────────────────────────────────────────────┘

时间 ─────────────────────────────────────────────────────────────────────→

终端1  [启动 PX4 + Gazebo]────────────────────────────────────────────────
         │
         │ 等待 Gazebo 窗口出现 + pxh> 提示符
         ▼
终端2  ──[启动 MAVROS]────────────────────────────────────────────────────
              │
              │ 等待 "FCU connected" 消息
              ▼
终端3  ───────[运行 Python 控制代码]───────────────────────────────────────
                    │
                    ├── 预发送设定点 (5秒)
                    ├── 切换 OFFBOARD 模式
                    ├── 解锁 ARM
                    ├── 起飞
                    ├── 执行任务
                    └── 降落
```

## 二、终端 1：启动 PX4 SITL + Gazebo

### 命令

```bash
cd ~/PX4-Autopilot
make px4_sitl gazebo
```

### 这条命令做了什么

```
make px4_sitl gazebo
├── 1. 编译 PX4 固件（SITL 版本）
├── 2. 启动 Gazebo 仿真器
├── 3. 在 Gazebo 中加载无人机模型（默认是 iris 四旋翼）
├── 4. 启动 PX4 飞控软件
└── 5. PX4 通过 UDP 端口等待连接
        ├── 端口 14540: 发送数据给外部
        └── 端口 14557: 接收外部数据
```

### 成功标志

```
你会看到：
1. Gazebo 窗口打开，显示一架四旋翼无人机
2. 终端显示 PX4 启动日志
3. 出现 pxh> 命令提示符（PX4 Shell）

示例输出：
______  __   __    ___
| ___ \ \ \ / /   /   |
| |_/ /  \ V /   / /| |
|  __/   /   \  / /_| |
| |     / /^\ \ \___  |
\_|     \/   \/     |_/

px4 starting.
...
INFO  [commander] Ready for takeoff!

pxh>
```

### PX4 终端常用命令

```bash
# 查看飞控状态
pxh> commander status

# 手动解锁（测试用）
pxh> commander arm

# 手动起飞
pxh> commander takeoff

# 手动降落
pxh> commander land

# 查看参数
pxh> param show COM_RCL_EXCEPT

# 设置参数（重要！允许无遥控器使用 OFFBOARD）
pxh> param set COM_RCL_EXCEPT 4
pxh> param set NAV_RCL_ACT 0
pxh> param set NAV_DLL_ACT 0
```

---

## 三、终端 2：启动 MAVROS

### 命令

```bash
roslaunch mavros px4.launch fcu_url:="udp://:14540@127.0.0.1:14557"
```

### 参数详解

```
fcu_url:="udp://:14540@127.0.0.1:14557"
          │      │      │          │
          │      │      │          └── MAVROS 发送数据的目标端口
          │      │      └───────────── 目标 IP（本机 = 127.0.0.1）
          │      └──────────────────── MAVROS 监听的端口（接收 PX4 数据）
          └─────────────────────────── 通信协议（UDP）

简单理解：
  MAVROS 在 14540 端口听 PX4 说话
  MAVROS 往 127.0.0.1:14557 端口给 PX4 发消息
```

### 这条命令做了什么

```
roslaunch mavros px4.launch ...
├── 1. 启动 ROS Master（如果还没启动）
├── 2. 启动 MAVROS 节点
├── 3. 建立与 PX4 的 UDP 连接
├── 4. 创建一系列 ROS 话题
│       ├── /mavros/state
│       ├── /mavros/local_position/pose
│       ├── /mavros/setpoint_position/local
│       └── ...
└── 5. 开始转发消息
        ├── ROS → MAVLink → PX4
        └── PX4 → MAVLink → ROS
```

### 成功标志

```
你会看到大量日志，关键信息：

[ INFO] [xxx]: FCU: [inav] init ref: 47.39, 8.54, 0.00
[ INFO] [xxx]: FCU: [commander] Ready for takeoff!
...
[ INFO] [xxx]: GF: mission received
[ INFO] [xxx]: RP: mission received
[ INFO] [xxx]: WP: mission received

关键：看到 "FCU:" 开头的消息说明连接成功
```

### 验证连接

```bash
# 打开新终端，查看飞控状态
rostopic echo /mavros/state

# 应该看到：
# connected: True
# armed: False
# mode: "MANUAL"
```

---

## 四、终端 3：运行控制代码

### 命令

```bash
cd ~/uav-research-platform-/src/phase0_foundation
python3 offboard_control.py
```

### 执行流程

```
offboard_control.py 执行过程：

1. 初始化 ROS 节点
   │
2. 创建发布者和订阅者
   │
3. 等待飞控连接
   │  while not state.connected:
   │      sleep()
   │
4. 预发送设定点 (5秒, 100次)
   │  for i in range(100):
   │      send_setpoint(0, 0, 2)
   │      sleep(0.05)
   │
5. 请求切换 OFFBOARD 模式
   │  set_mode("OFFBOARD")
   │
6. 请求解锁
   │  arm()
   │
7. 起飞到 2 米
   │  while height < 2.0:
   │      send_setpoint(0, 0, 2)
   │
8. 悬停 5 秒
   │
9. 飞到 (2, 2, 2)
   │
10. 返回原点 (0, 0, 2)
    │
11. 降落
    │  set_mode("AUTO.LAND")
    │
12. 完成！
```

---

## 五、完整操作示例

### 步骤 1：打开三个终端

```
可以使用 tmux 或者打开三个终端窗口
```

### 步骤 2：终端 1 - 启动仿真

```bash
# 终端 1
cd ~/PX4-Autopilot
make px4_sitl gazebo

# 等待看到 pxh> 提示符
# 设置参数（只需要第一次）
pxh> param set COM_RCL_EXCEPT 4
```

### 步骤 3：终端 2 - 启动 MAVROS

```bash
# 终端 2
source ~/.bashrc
roslaunch mavros px4.launch fcu_url:="udp://:14540@127.0.0.1:14557"

# 等待看到 FCU: 相关消息
```

### 步骤 4：终端 3 - 运行代码

```bash
# 终端 3
cd ~/uav-research-platform-/src/phase0_foundation
python3 offboard_control.py

# 观察 Gazebo 窗口中无人机的动作
```

---

## 六、启动顺序的重要性

```
问：三个终端的启动顺序能不能换？

答：不能随意换！

原因：

1. PX4 必须先启动
   └── 因为 MAVROS 要连接它

2. MAVROS 必须在 PX4 之后
   └── 因为你的代码通过 MAVROS 通信

3. 你的代码必须最后
   └── 因为它依赖前两者都就绪


依赖关系图：

   你的代码
      │
      │ 依赖
      ▼
   MAVROS
      │
      │ 依赖
      ▼
   PX4 + Gazebo


如果顺序错了会怎样：

错误 1: 先启动 MAVROS
  → MAVROS 报错找不到 PX4
  → 需要重启 MAVROS

错误 2: 先运行 Python 代码
  → ROS 话题不存在
  → 代码报错退出
```

---

## 七、常见问题排查

### 问题 1：Gazebo 启动很慢/卡住

```
原因：首次启动需要下载模型

解决：
  - 耐心等待（可能需要几分钟）
  - 或手动下载模型到 ~/.gazebo/models/
  - 检查网络连接
```

### 问题 2：MAVROS 连接失败

```
原因：端口不匹配或 PX4 未启动

解决：
  - 确保 PX4 已经启动（看到 pxh>）
  - 检查 fcu_url 参数是否正确
  - 检查防火墙设置
```

### 问题 3：Python 代码报错 "Topic not found"

```
原因：MAVROS 未启动或未连接

解决：
  - 确保 MAVROS 已启动并连接成功
  - 使用 rostopic list 检查话题是否存在
```

### 问题 4：无人机不起飞

```
原因：OFFBOARD 切换失败或未解锁

解决：
  - 设置 PX4 参数: param set COM_RCL_EXCEPT 4
  - 检查 /mavros/state 确认连接状态
  - 查看终端输出的错误信息
```

---

## 八、总结

```
启动三步曲：

┌─────────────────────────────────────────────────────────────────┐
│  终端 1: cd ~/PX4-Autopilot && make px4_sitl gazebo            │
│          → 等待 pxh> 出现                                       │
│          → (可选) 设置参数 param set COM_RCL_EXCEPT 4           │
├─────────────────────────────────────────────────────────────────┤
│  终端 2: roslaunch mavros px4.launch fcu_url:="udp://..."      │
│          → 等待 FCU: 消息出现                                   │
├─────────────────────────────────────────────────────────────────┤
│  终端 3: python3 offboard_control.py                           │
│          → 观察 Gazebo 中无人机动作                             │
└─────────────────────────────────────────────────────────────────┘
```
